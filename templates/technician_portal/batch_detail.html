{% extends 'base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Batch Repair Details - Technician View</h2>

    <div class="mb-4">
        <a href="{% url 'technician_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Batch Summary Card -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-layer-group"></i>
                Unit {{ batch_summary.unit_number }}: {{ batch_summary.break_count }} Breaks
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong>Customer:</strong> {{ batch_summary.customer.name }}</p>
                    <p class="mb-2"><strong>Unit Number:</strong> {{ batch_summary.unit_number }}</p>
                    <p class="mb-2"><strong>Repair Date:</strong> {{ batch_summary.repair_date|date:"M d, Y g:i A" }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-2"><strong>Total Breaks:</strong> {{ batch_summary.break_count }}</p>
                    <p class="mb-2"><strong>Total Cost:</strong> ${{ batch_summary.total_cost|floatformat:2 }}</p>
                    <p class="mb-2">
                        <strong>Status:</strong>
                        <span class="badge {% if batch_summary.current_status == 'COMPLETED' %}bg-success{% elif batch_summary.current_status == 'IN_PROGRESS' %}bg-warning text-dark{% elif batch_summary.current_status == 'DENIED' %}bg-danger{% elif batch_summary.current_status == 'APPROVED' %}bg-info{% elif batch_summary.current_status == 'PENDING' %}bg-secondary{% else %}bg-light text-dark{% endif %}">
                            {{ batch_summary.current_status }}
                        </span>
                    </p>
                </div>
            </div>

            <!-- Progress Bar -->
            {% if batch_summary.current_status in 'IN_PROGRESS,MIXED' or batch_summary.completed_count > 0 %}
            <div class="mt-3 border-top pt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong class="text-muted">Progress:</strong>
                    <span class="badge bg-primary">{{ batch_summary.completed_count }} of {{ batch_summary.break_count }} complete</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ batch_summary.progress_percentage }}%;" aria-valuenow="{{ batch_summary.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        {{ batch_summary.progress_percentage }}%
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Next Break to Work On -->
    {% if batch_summary.in_progress_count > 0 %}
    {% with next_break=None %}
        {% for repair in repairs %}
            {% if repair.queue_status == 'IN_PROGRESS' and not next_break %}
                {% with next_break=repair %}
                <div class="alert alert-warning border-warning" style="border-width: 3px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="alert-heading mb-2">
                                <i class="fas fa-arrow-right"></i> Next Break to Complete
                            </h5>
                            <p class="mb-0">
                                <strong>Break {{ repair.break_number }} of {{ batch_summary.break_count }}</strong> - {{ repair.get_damage_type_display }} (${{ repair.cost|floatformat:2 }})
                            </p>
                        </div>
                        <a href="{% url 'update_repair' repair.id %}?batch_id={{ batch_summary.batch_id }}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Complete This Break Now
                        </a>
                    </div>
                </div>
                {% endwith %}
            {% endif %}
        {% endfor %}
    {% endwith %}
    {% endif %}

    <!-- Batch Actions (if approved and technician can start work) -->
    {% if can_start_work %}
    <div class="card mb-4 bg-light">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-play-circle"></i> Batch Actions</h5>
            <p class="text-muted mb-3">Start work on all {{ batch_summary.break_count }} breaks at once:</p>

            <form method="post" action="{% url 'technician_batch_start_work' batch_summary.batch_id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-play-circle"></i> Start Work on All {{ batch_summary.break_count }} Breaks
                </button>
            </form>

            <hr class="my-4">

            <p class="text-muted small">
                <strong>Or start work on individual breaks:</strong>
                Use the action buttons on each break below to start work on them separately.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Individual Breaks -->
    <h4 class="mb-3">Individual Breaks in This Batch</h4>

    {% for repair in repairs %}
    <div class="card mb-3 {% if repair.queue_status == 'COMPLETED' %}border-success{% elif repair.queue_status == 'IN_PROGRESS' %}border-warning{% elif repair.queue_status == 'APPROVED' %}border-info{% elif repair.queue_status == 'DENIED' %}border-danger{% else %}border-secondary{% endif %}" style="border-width: 3px;">
        <div class="card-header d-flex justify-content-between align-items-center {% if repair.queue_status == 'COMPLETED' %}bg-success bg-opacity-10 border-success{% elif repair.queue_status == 'IN_PROGRESS' %}bg-warning bg-opacity-10 border-warning{% elif repair.queue_status == 'APPROVED' %}bg-info bg-opacity-10 border-info{% elif repair.queue_status == 'DENIED' %}bg-danger bg-opacity-10 border-danger{% else %}bg-light{% endif %}">
            <h6 class="mb-0">
                {% if repair.queue_status == 'COMPLETED' %}
                <i class="fas fa-check-circle text-success"></i>
                {% elif repair.queue_status == 'IN_PROGRESS' %}
                <i class="fas fa-spinner text-warning"></i>
                {% else %}
                <i class="fas fa-tools"></i>
                {% endif %}
                Break {{ repair.break_number }} of {{ batch_summary.break_count }}
            </h6>
            <span class="badge {% if repair.queue_status == 'COMPLETED' %}bg-success{% elif repair.queue_status == 'IN_PROGRESS' %}bg-warning text-dark{% elif repair.queue_status == 'DENIED' %}bg-danger{% elif repair.queue_status == 'APPROVED' %}bg-info{% elif repair.queue_status == 'PENDING' %}bg-secondary{% else %}bg-primary{% endif %}">
                {{ repair.get_queue_status_display }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong>Damage Type:</strong> {{ repair.get_damage_type_display }}</p>
                    <p class="mb-2"><strong>Cost:</strong> ${{ repair.cost|floatformat:2 }}</p>
                    {% if repair.cost_override %}
                    <p class="mb-2 text-warning">
                        <strong><i class="fas fa-dollar-sign"></i> Manager Price Override:</strong> Applied
                    </p>
                    {% endif %}
                    {% if repair.override_reason %}
                    <p class="mb-2 text-muted small">
                        <strong>Override Reason:</strong> {{ repair.override_reason }}
                    </p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if repair.technician %}
                    <p class="mb-2"><strong>Assigned to:</strong> {{ repair.technician.user.username }}</p>
                    {% endif %}
                    {% if repair.windshield_temperature %}
                    <p class="mb-2"><strong><i class="fas fa-thermometer-half"></i> Temperature:</strong> {{ repair.windshield_temperature }}Â°F</p>
                    {% endif %}
                    {% if repair.resin_viscosity %}
                    <p class="mb-2"><strong><i class="fas fa-droplet"></i> Resin Viscosity:</strong> {{ repair.resin_viscosity }}</p>
                    {% endif %}
                    {% if repair.drilled_before_repair %}
                    <p class="mb-2"><strong><i class="fas fa-check-circle text-success"></i> Pre-drilled</strong></p>
                    {% endif %}
                </div>
            </div>

            {% if repair.notes %}
            <div class="mt-3">
                <strong>Technician Notes:</strong>
                <p class="text-muted">{{ repair.notes }}</p>
            </div>
            {% endif %}

            <!-- Photos -->
            {% if repair.damage_photo_before or repair.damage_photo_after %}
            <div class="mt-3">
                <strong>Photos:</strong>
                <div class="row mt-2">
                    {% if repair.damage_photo_before %}
                    <div class="col-md-6 mb-2">
                        <p class="small text-muted">Before:</p>
                        <img src="{{ repair.damage_photo_before.url }}"
                             alt="Before"
                             class="img-fluid rounded"
                             style="max-height: 300px;"
                             loading="lazy"
                             decoding="async">
                    </div>
                    {% endif %}
                    {% if repair.damage_photo_after %}
                    <div class="col-md-6 mb-2">
                        <p class="small text-muted">After:</p>
                        <img src="{{ repair.damage_photo_after.url }}"
                             alt="After"
                             class="img-fluid rounded"
                             style="max-height: 300px;"
                             loading="lazy"
                             decoding="async">
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Individual Actions -->
            <div class="mt-3 border-top pt-3">
                <p class="text-muted small mb-2"><strong>Individual Break Actions:</strong></p>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="{% url 'repair_detail' repair.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    {% if repair.queue_status == 'APPROVED' and repair.technician.id == technician.id %}
                    <form method="post" action="{% url 'update_queue_status' repair.id %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="new_status" value="IN_PROGRESS">
                        <button type="submit" class="btn btn-outline-success">
                            <i class="fas fa-play"></i> Start This Break
                        </button>
                    </form>
                    {% endif %}
                    {% if repair.queue_status == 'IN_PROGRESS' and repair.technician.id == technician.id %}
                    <a href="{% url 'update_repair' repair.id %}?batch_id={{ batch_summary.batch_id }}" class="btn btn-outline-warning">
                        <i class="fas fa-edit"></i> Complete This Break
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Back to Dashboard -->
    <div class="mt-4 text-center">
        <a href="{% url 'technician_dashboard' %}" class="btn btn-secondary">
            <i class="fa fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
