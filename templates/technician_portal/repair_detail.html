{% extends "base.html" %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    green: {
                        50: '#f0fdf4',
                        100: '#dcfce7',
                        200: '#bbf7d0',
                        300: '#86efac',
                        400: '#4ade80',
                        500: '#22c55e',
                        600: '#16a34a',
                        700: '#15803d',
                        800: '#166534',
                        900: '#14532d',
                    }
                }
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-green-600 text-white rounded-t-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold">Repair #{{ repair.id }} - {{ repair.customer.name }}</h1>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                                {% if repair.queue_status == 'COMPLETED' %}bg-green-100 text-green-800
                                {% elif repair.queue_status == 'IN_PROGRESS' %}bg-blue-100 text-blue-800
                                {% elif repair.queue_status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                {% elif repair.queue_status == 'APPROVED' %}bg-indigo-100 text-indigo-800
                                {% elif repair.queue_status == 'DENIED' %}bg-red-100 text-red-800
                                {% elif repair.queue_status == 'REQUESTED' %}bg-gray-100 text-gray-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ repair.get_queue_status_display }}
                            </span>
                        </div>
                    </div>
                    <a href="{% url 'repair_list' %}" class="inline-flex items-center px-3 py-1 border border-white border-opacity-20 text-white text-sm font-medium rounded hover:bg-white hover:bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Repairs
                    </a>
                </div>
            </div>

            <!-- Batch Context Banner (if part of batch) -->
            {% if repair.is_part_of_batch %}
            <div class="px-6 py-4 bg-blue-50 border-b border-blue-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-900">Part of Multi-Break Batch</h3>
                            <p class="text-sm text-blue-700">Break {{ repair.break_number }} of {{ repair.total_breaks_in_batch }} for Unit {{ repair.unit_number }}</p>
                        </div>
                    </div>
                    <a href="{% url 'technician_batch_detail' repair.repair_batch_id %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        View All {{ repair.total_breaks_in_batch }} Breaks
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Convert to Batch Banner (if NOT part of batch and status allows) -->
            {% if not repair.is_part_of_batch and repair.queue_status in 'APPROVED,IN_PROGRESS' %}
            <div class="px-6 py-4 bg-amber-50 border-b border-amber-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <div>
                            <h3 class="text-sm font-semibold text-amber-900">Found More Breaks On-Site?</h3>
                            <p class="text-xs text-amber-700">Add additional breaks to create a multi-break batch for this unit</p>
                        </div>
                    </div>
                    <a href="{% url 'convert_to_batch' repair.id %}" class="inline-flex items-center px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add More Breaks
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions Bar (Sticky at Top) -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200 sticky top-0 z-10 shadow-sm">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between gap-4 flex-wrap">
                        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Quick Actions
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            <!-- Batch Navigation (if part of batch) -->
                            {% if repair.is_part_of_batch and batch_info %}
                            <a href="{% url 'technician_batch_detail' repair.repair_batch_id %}" class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                Return to Batch
                            </a>
                            {% if next_break %}
                            <a href="{% url 'update_repair' next_break.id %}?batch_id={{ repair.repair_batch_id }}" class="inline-flex items-center px-3 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                                </svg>
                                Next Break ({{ next_break.break_number }}/{{ batch_info.break_count }})
                            </a>
                            {% elif batch_info.completed_count == batch_info.break_count %}
                            <span class="inline-flex items-center px-3 py-2 bg-green-100 text-green-800 text-sm font-medium rounded">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                All Breaks Complete!
                            </span>
                            {% endif %}
                            {% endif %}

                            <!-- Manager Assignment (REQUESTED repairs only) -->
                            {% if repair.queue_status == 'REQUESTED' %}
                                {% if user.technician and user.technician.is_manager or is_admin %}
                                <a href="{% url 'assign_repair' repair.id %}" class="inline-flex items-center px-3 py-2 bg-purple-600 text-white text-sm font-medium rounded hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                                    <i class="fas fa-user-plus mr-1.5"></i>Assign
                                </a>
                                {% endif %}
                            {% endif %}

                            <!-- Edit Repair Button -->
                            {% if is_admin %}
                                <a href="{% url 'update_repair' repair.id %}{% if repair.is_part_of_batch %}?batch_id={{ repair.repair_batch_id }}{% endif %}" class="inline-flex items-center px-3 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    <i class="fas fa-edit mr-1.5"></i>Edit Repair
                                </a>
                            {% elif user.technician and user.technician.is_manager %}
                                <a href="{% url 'update_repair' repair.id %}{% if repair.is_part_of_batch %}?batch_id={{ repair.repair_batch_id }}{% endif %}" class="inline-flex items-center px-3 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    <i class="fas fa-edit mr-1.5"></i>Edit Repair
                                    {% if repair.queue_status == 'COMPLETED' or repair.queue_status == 'DENIED' %}
                                    <span class="ml-1.5 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Manager</span>
                                    {% endif %}
                                </a>
                            {% elif repair.queue_status not in 'COMPLETED,DENIED' and repair.technician and repair.technician == user.technician %}
                                <a href="{% url 'update_repair' repair.id %}{% if repair.is_part_of_batch %}?batch_id={{ repair.repair_batch_id }}{% endif %}" class="inline-flex items-center px-3 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    <i class="fas fa-edit mr-1.5"></i>Edit Repair
                                </a>
                            {% endif %}

                            <!-- Reassign to Self (managers only) -->
                            {% if can_reassign_to_self %}
                            <a href="{% url 'reassign_to_self' repair.id %}" class="inline-flex items-center px-3 py-2 bg-purple-600 text-white text-sm font-medium rounded hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                                <i class="fas fa-user-check mr-1.5"></i>Reassign to Me
                            </a>
                            {% endif %}

                            <!-- Status Update Buttons -->
                            {% if can_update_status %}
                                {% if repair.queue_status == 'REQUESTED' %}
                                <form action="{% url 'update_queue_status' repair.id %}" method="post" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="status" value="APPROVED">
                                    <button type="submit" class="inline-flex items-center px-3 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                        <i class="fas fa-check mr-1.5"></i>Accept Repair
                                    </button>
                                </form>
                                {% elif repair.queue_status == 'APPROVED' %}
                                <form action="{% url 'update_queue_status' repair.id %}" method="post" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="status" value="IN_PROGRESS">
                                    <button type="submit" class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                        <i class="fas fa-play mr-1.5"></i>Start Repair
                                    </button>
                                </form>
                                {% elif repair.queue_status == 'IN_PROGRESS' %}
                                <form action="{% url 'update_queue_status' repair.id %}" method="post" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="status" value="COMPLETED">
                                    <button type="submit" class="inline-flex items-center px-3 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                        <i class="fas fa-check mr-1.5"></i>Complete Repair
                                    </button>
                                </form>
                                {% endif %}
                            {% endif %}

                            <!-- Apply Reward -->
                            <a href="{% url 'apply_reward_to_repair' repair.id %}" class="inline-flex items-center px-3 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors">
                                <i class="fas fa-gift mr-1.5"></i>Apply Reward
                            </a>

                            <!-- Admin Actions Dropdown -->
                            {% if is_admin %}
                            <div class="relative inline-block text-left">
                                <button type="button" class="inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-gray-700 text-sm font-medium rounded hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors" id="adminActionsDropdown" onclick="toggleDropdown()">
                                    <i class="fas fa-cog mr-1.5"></i>Admin
                                    <i class="fas fa-chevron-down ml-1"></i>
                                </button>
                                <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20">
                                    <div class="py-1">
                                        {% for status, label in repair.QUEUE_CHOICES %}
                                        <form action="{% url 'update_queue_status' repair.id %}" method="post" class="block">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="{{ status }}">
                                            <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Set: {{ label }}</button>
                                        </form>
                                        {% endfor %}
                                        <div class="border-t border-gray-100"></div>
                                        <a href="{% url 'admin:technician_portal_repair_change' repair.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit in Admin</a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Dashboard Link -->
                            <a href="{% url 'technician_dashboard' %}" class="inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-gray-700 text-sm font-medium rounded hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                                <i class="fas fa-home mr-1.5"></i>Dashboard
                            </a>
                        </div>
                    </div>

                    <!-- Batch Progress Indicator (if part of batch) -->
                    {% if repair.is_part_of_batch and batch_info %}
                    <div class="mt-3 pt-3 border-t border-gray-300">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-700 font-medium">
                                Break {{ repair.break_number }} of {{ batch_info.break_count }} - Batch Progress: {{ batch_info.progress_percentage }}%
                            </span>
                            <span class="text-gray-600">
                                {{ batch_info.completed_count }} completed, {{ batch_info.in_progress_count }} in progress
                            </span>
                        </div>
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: {{ batch_info.progress_percentage }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Customer Information -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-900 mb-3">
                            <i class="fas fa-user mr-2"></i>Customer Information
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium text-blue-700">Customer:</span> <span class="text-blue-900">{{ repair.customer.name }}</span></div>
                            <div><span class="font-medium text-blue-700">Contact:</span> <span class="text-blue-900">{{ repair.customer.email }}</span></div>
                            <div><span class="font-medium text-blue-700">Phone:</span> <span class="text-blue-900">{{ repair.customer.phone }}</span></div>
                            <div><span class="font-medium text-blue-700">Unit Number:</span> <span class="text-blue-900">{{ repair.unit_number }}</span></div>
                        </div>
                    </div>

                    <!-- Repair Information -->
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <h4 class="text-lg font-semibold text-green-900 mb-3">
                            <i class="fas fa-tools mr-2"></i>Repair Information
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium text-green-700">Date:</span> <span class="text-green-900">{{ repair.repair_date|date:"F j, Y, g:i a" }}</span></div>
                            <div><span class="font-medium text-green-700">Damage Type:</span> <span class="text-green-900">{{ repair.damage_type }}</span></div>
                            <div><span class="font-medium text-green-700">Technician:</span> <span class="text-green-900">{{ repair.technician.user.get_full_name }}</span></div>
                        </div>
                    </div>

                    <!-- Cost Information -->
                    <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                        <h4 class="text-lg font-semibold text-yellow-900 mb-3">
                            <i class="fas fa-dollar-sign mr-2"></i>Cost Information
                            {% if repair.has_price_override %}
                            <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800" title="{{ repair.override_reason|default:'Manual override' }}">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Override
                            </span>
                            {% endif %}
                        </h4>
                        {% with cost_info=repair.get_discounted_cost %}
                        {% if cost_info.discount_applied %}
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium text-yellow-700">Original Cost:</span> <span class="line-through text-gray-500">${{ cost_info.original_cost }}</span></div>
                            <div><span class="font-medium text-yellow-700">Discount:</span> <span class="text-green-600 font-medium">{{ cost_info.discount_description }}</span></div>
                            <div><span class="font-medium text-yellow-700">Final Cost:</span> <span class="text-yellow-900 font-bold text-lg">${{ cost_info.final_cost }}</span></div>
                            <div><span class="font-medium text-yellow-700">Savings:</span> <span class="text-green-600 font-medium">${{ cost_info.savings }}</span></div>
                        </div>
                        {% else %}
                        <div class="text-sm">
                            {% if repair.queue_status != 'COMPLETED' %}
                            <div><span class="font-medium text-yellow-700">Expected Cost:</span> <span class="text-yellow-900 font-bold text-lg">${{ repair.get_expected_price }}</span></div>
                            {% else %}
                            <div><span class="font-medium text-yellow-700">Cost:</span> <span class="text-yellow-900 font-bold text-lg">${{ repair.cost }}</span></div>
                            {% endif %}
                            {% if repair.has_price_override %}
                            <div class="mt-2 text-xs text-red-600">
                                <span class="font-medium">Override reason:</span> {{ repair.override_reason|default:"No reason provided" }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            
                <!-- Notes Section -->
                {% if repair.customer_notes or repair.technician_notes %}
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-comments mr-2"></i>Notes & Communications
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if repair.customer_notes %}
                        <div class="bg-blue-50 rounded-lg border border-blue-200 overflow-hidden">
                            <div class="bg-blue-600 text-white px-4 py-2">
                                <h6 class="text-sm font-medium flex items-center">
                                    <i class="fas fa-user mr-2"></i>Customer Notes
                                </h6>
                            </div>
                            <div class="p-4">
                                <p class="text-blue-900 text-sm">{{ repair.customer_notes }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if repair.technician_notes %}
                        <div class="bg-green-50 rounded-lg border border-green-200 overflow-hidden">
                            <div class="bg-green-600 text-white px-4 py-2">
                                <h6 class="text-sm font-medium flex items-center">
                                    <i class="fas fa-wrench mr-2"></i>Technician Notes
                                </h6>
                            </div>
                            <div class="p-4">
                                <p class="text-green-900 text-sm">{{ repair.technician_notes }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            
            <!-- Photo Documentation Section -->
            {% if repair.customer_submitted_photo or repair.damage_photo_before or repair.damage_photo_after %}
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-camera text-blue-600 mr-2"></i>Photo Documentation
                        <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ repair.get_photo_count }} photo{{ repair.get_photo_count|pluralize }}
                        </span>
                    </h4>
                    <button type="button" 
                            id="photoToggleBtn" 
                            class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md transition-colors"
                            onclick="togglePhotoSection()">
                        <i id="photoToggleIcon" class="fas fa-chevron-down mr-1"></i>
                        <span id="photoToggleText">Hide Photos</span>
                    </button>
                </div>
                
                <div id="photoContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Customer Submitted Photo (if exists) -->
                    {% if repair.customer_submitted_photo %}
                    <div class="bg-white rounded-lg border-2 border-purple-300 shadow-sm overflow-hidden">
                        <div class="bg-purple-600 text-white px-3 py-2 text-center">
                            <h6 class="text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-user mr-2"></i>Customer Photo
                            </h6>
                            <p class="text-xs text-purple-100 mt-1">Submitted with repair request</p>
                        </div>
                        <div class="p-2 text-center">
                            <div class="photo-container">
                                <img src="{{ repair.customer_submitted_photo.url }}"
                                     alt="Customer submitted photo"
                                     class="w-full h-auto max-h-80 object-contain rounded-lg shadow-sm cursor-pointer"
                                     onclick="openImageModal('{{ repair.customer_submitted_photo.url }}', 'Customer Submitted Photo')"
                                     loading="lazy"
                                     decoding="async">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Click to view full size</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Technician Before Photo -->
                    {% if repair.damage_photo_before %}
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                        <div class="bg-blue-600 text-white px-3 py-2 text-center">
                            <h6 class="text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-camera mr-2"></i>Before Repair (Tech)
                            </h6>
                        </div>
                        <div class="p-2 text-center">
                            <div class="photo-container">
                                <img src="{{ repair.damage_photo_before.url }}"
                                     alt="Initial damage photo"
                                     class="w-full h-auto max-h-80 object-contain rounded-lg shadow-sm cursor-pointer"
                                     onclick="openImageModal('{{ repair.damage_photo_before.url }}', 'Initial Damage Photo')"
                                     loading="lazy"
                                     decoding="async">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Click to view full size</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Technician After Photo -->
                    {% if repair.damage_photo_after %}
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                        <div class="bg-green-600 text-white px-3 py-2 text-center">
                            <h6 class="text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-check-circle mr-2"></i>After Repair (Tech)
                            </h6>
                        </div>
                        <div class="p-2 text-center">
                            <div class="photo-container">
                                <img src="{{ repair.damage_photo_after.url }}"
                                     alt="Completed repair photo"
                                     class="w-full h-auto max-h-80 object-contain rounded-lg shadow-sm cursor-pointer"
                                     onclick="openImageModal('{{ repair.damage_photo_after.url }}', 'Completed Repair Photo')"
                                     loading="lazy"
                                     decoding="async">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Click to view full size</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if not repair.damage_photo_after and repair.queue_status == 'IN_PROGRESS' %}
                <div id="photoReminder" class="mt-4 bg-blue-50 border-l-4 border-blue-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Reminder:</strong> Don't forget to take an "after" photo once the repair is completed for documentation purposes.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Show photo upload reminder when no photos exist -->
            {% if repair.queue_status != 'COMPLETED' %}
            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-amber-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-amber-700">
                            <strong>Photo Documentation:</strong> Consider adding before and after photos to better document this repair. Use the
                            <a href="{% url 'update_repair' repair.id %}{% if repair.is_part_of_batch %}?batch_id={{ repair.repair_batch_id }}{% endif %}" class="underline font-medium">Edit Repair</a> button to upload photos.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
            
            {% if repair.queue_status == 'REQUESTED' %}
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mt-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-purple-800">Customer Requested Repair</h3>
                        <div class="mt-2 text-sm text-purple-700">
                            <p>This repair was requested directly by the customer. {% if user.technician and user.technician.is_manager or is_admin %}Please assign this repair to a technician to begin work.{% else %}This repair needs to be assigned by a manager before work can begin.{% endif %}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
                <!-- Technical Details -->
                {% if repair.drilled_before_repair or repair.windshield_temperature or repair.resin_viscosity %}
                <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200 mb-6">
                    <h4 class="text-lg font-semibold text-indigo-900 mb-3">
                        <i class="fas fa-cogs mr-2"></i>Technical Details
                    </h4>
                    <div class="space-y-2 text-sm">
                        {% if repair.drilled_before_repair %}
                        <div><span class="font-medium text-indigo-700">Drilled Before Repair:</span> <span class="text-indigo-900">Yes</span></div>
                        {% endif %}
                        {% if repair.windshield_temperature %}
                        <div><span class="font-medium text-indigo-700">Windshield Temperature:</span> <span class="text-indigo-900">{{ repair.windshield_temperature }}Â°F</span></div>
                        {% endif %}
                        {% if repair.resin_viscosity %}
                        <div><span class="font-medium text-indigo-700">Resin Viscosity:</span> <span class="text-indigo-900">{{ repair.resin_viscosity }}</span></div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Applied Rewards -->
                {% if repair.applied_rewards.exists %}
                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-purple-900">
                            <i class="fas fa-gift mr-2"></i>Applied Rewards
                        </h4>
                        <span class="text-xs text-purple-600 italic">
                            <i class="fas fa-info-circle mr-1"></i>Only one reward per repair
                        </span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-purple-200">
                            <thead class="bg-purple-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Reward</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Applied On</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-purple-200">
                                {% for redemption in repair.applied_rewards.all %}
                                <tr>
                                    <td class="px-4 py-2 text-sm text-purple-900">{{ redemption.reward_option.name }}</td>
                                    <td class="px-4 py-2 text-sm text-purple-900">
                                        {% if redemption.reward_option.reward_type %}
                                            {{ redemption.reward_option.reward_type }}
                                        {% else %}
                                            Standard Reward
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-2 text-sm">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                            {% if redemption.status == 'FULFILLED' %}bg-green-100 text-green-800
                                            {% elif redemption.status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ redemption.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-2 text-sm text-purple-900">{{ redemption.processed_at|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid">
            </div>
        </div>
    </div>
</div>


<script>
function openImageModal(imageUrl, title) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('imageModalLabel').textContent = title;
    var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    imageModal.show();
}


function toggleDropdown() {
    const dropdown = document.getElementById('dropdownMenu');
    dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('dropdownMenu');
    const button = document.getElementById('adminActionsDropdown');
    
    if (dropdown && button && !button.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// Photo section toggle functionality
function togglePhotoSection() {
    const photoContent = document.getElementById('photoContent');
    const photoReminder = document.getElementById('photoReminder');
    const toggleIcon = document.getElementById('photoToggleIcon');
    const toggleText = document.getElementById('photoToggleText');
    
    const isVisible = !photoContent.classList.contains('hidden');
    
    if (isVisible) {
        // Hide photos
        photoContent.classList.add('hidden');
        if (photoReminder) photoReminder.classList.add('hidden');
        toggleIcon.className = 'fas fa-chevron-right mr-1';
        toggleText.textContent = 'Show Photos';
        localStorage.setItem('photoSectionCollapsed', 'true');
    } else {
        // Show photos
        photoContent.classList.remove('hidden');
        if (photoReminder) photoReminder.classList.remove('hidden');
        toggleIcon.className = 'fas fa-chevron-down mr-1';
        toggleText.textContent = 'Hide Photos';
        localStorage.setItem('photoSectionCollapsed', 'false');
    }
}

// Initialize photo section state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const photoContent = document.getElementById('photoContent');
    const photoReminder = document.getElementById('photoReminder');
    const toggleIcon = document.getElementById('photoToggleIcon');
    const toggleText = document.getElementById('photoToggleText');
    
    if (photoContent && localStorage.getItem('photoSectionCollapsed') === 'true') {
        photoContent.classList.add('hidden');
        if (photoReminder) photoReminder.classList.add('hidden');
        toggleIcon.className = 'fas fa-chevron-right mr-1';
        toggleText.textContent = 'Show Photos';
    }
});
</script>
{% endblock %}
