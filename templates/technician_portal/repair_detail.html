{% extends "base.html" %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    green: {
                        50: '#f0fdf4',
                        100: '#dcfce7',
                        200: '#bbf7d0',
                        300: '#86efac',
                        400: '#4ade80',
                        500: '#22c55e',
                        600: '#16a34a',
                        700: '#15803d',
                        800: '#166534',
                        900: '#14532d',
                    }
                }
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-green-600 text-white rounded-t-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold">Repair #{{ repair.id }} - {{ repair.customer.name }}</h1>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                                {% if repair.queue_status == 'COMPLETED' %}bg-green-100 text-green-800
                                {% elif repair.queue_status == 'IN_PROGRESS' %}bg-blue-100 text-blue-800
                                {% elif repair.queue_status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                {% elif repair.queue_status == 'APPROVED' %}bg-indigo-100 text-indigo-800
                                {% elif repair.queue_status == 'DENIED' %}bg-red-100 text-red-800
                                {% elif repair.queue_status == 'REQUESTED' %}bg-gray-100 text-gray-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ repair.get_queue_status_display }}
                            </span>
                        </div>
                    </div>
                    <a href="{% url 'repair_list' %}" class="inline-flex items-center px-3 py-1 border border-white border-opacity-20 text-white text-sm font-medium rounded hover:bg-white hover:bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Repairs
                    </a>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Customer Information -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-900 mb-3">
                            <i class="fas fa-user mr-2"></i>Customer Information
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium text-blue-700">Customer:</span> <span class="text-blue-900">{{ repair.customer.name }}</span></div>
                            <div><span class="font-medium text-blue-700">Contact:</span> <span class="text-blue-900">{{ repair.customer.email }}</span></div>
                            <div><span class="font-medium text-blue-700">Phone:</span> <span class="text-blue-900">{{ repair.customer.phone }}</span></div>
                            <div><span class="font-medium text-blue-700">Unit Number:</span> <span class="text-blue-900">{{ repair.unit_number }}</span></div>
                        </div>
                    </div>

                    <!-- Repair Information -->
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <h4 class="text-lg font-semibold text-green-900 mb-3">
                            <i class="fas fa-tools mr-2"></i>Repair Information
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium text-green-700">Date:</span> <span class="text-green-900">{{ repair.repair_date|date:"F j, Y, g:i a" }}</span></div>
                            <div><span class="font-medium text-green-700">Damage Type:</span> <span class="text-green-900">{{ repair.damage_type }}</span></div>
                            <div><span class="font-medium text-green-700">Technician:</span> <span class="text-green-900">{{ repair.technician.user.get_full_name }}</span></div>
                        </div>
                    </div>

                    <!-- Cost Information -->
                    <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                        <h4 class="text-lg font-semibold text-yellow-900 mb-3">
                            <i class="fas fa-dollar-sign mr-2"></i>Cost Information
                        </h4>
                        {% with cost_info=repair.get_discounted_cost %}
                        {% if cost_info.discount_applied %}
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium text-yellow-700">Original Cost:</span> <span class="line-through text-gray-500">${{ cost_info.original_cost }}</span></div>
                            <div><span class="font-medium text-yellow-700">Discount:</span> <span class="text-green-600 font-medium">{{ cost_info.discount_description }}</span></div>
                            <div><span class="font-medium text-yellow-700">Final Cost:</span> <span class="text-yellow-900 font-bold text-lg">${{ cost_info.final_cost }}</span></div>
                            <div><span class="font-medium text-yellow-700">Savings:</span> <span class="text-green-600 font-medium">${{ cost_info.savings }}</span></div>
                        </div>
                        {% else %}
                        <div class="text-sm">
                            <div><span class="font-medium text-yellow-700">Cost:</span> <span class="text-yellow-900 font-bold text-lg">${{ repair.cost }}</span></div>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            
                <!-- Notes Section -->
                {% if repair.customer_notes or repair.technician_notes %}
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-comments mr-2"></i>Notes & Communications
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if repair.customer_notes %}
                        <div class="bg-blue-50 rounded-lg border border-blue-200 overflow-hidden">
                            <div class="bg-blue-600 text-white px-4 py-2">
                                <h6 class="text-sm font-medium flex items-center">
                                    <i class="fas fa-user mr-2"></i>Customer Notes
                                </h6>
                            </div>
                            <div class="p-4">
                                <p class="text-blue-900 text-sm">{{ repair.customer_notes }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if repair.technician_notes %}
                        <div class="bg-green-50 rounded-lg border border-green-200 overflow-hidden">
                            <div class="bg-green-600 text-white px-4 py-2">
                                <h6 class="text-sm font-medium flex items-center">
                                    <i class="fas fa-wrench mr-2"></i>Technician Notes
                                </h6>
                            </div>
                            <div class="p-4">
                                <p class="text-green-900 text-sm">{{ repair.technician_notes }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            
            <!-- Photo Documentation Section -->
            {% if repair.damage_photo_before or repair.damage_photo_after %}
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-camera text-blue-600 mr-2"></i>Photo Documentation
                        <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ repair.get_photo_count }} photo{{ repair.get_photo_count|pluralize }}
                        </span>
                    </h4>
                    <button type="button" 
                            id="photoToggleBtn" 
                            class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md transition-colors"
                            onclick="togglePhotoSection()">
                        <i id="photoToggleIcon" class="fas fa-chevron-down mr-1"></i>
                        <span id="photoToggleText">Hide Photos</span>
                    </button>
                </div>
                
                <div id="photoContent" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% if repair.damage_photo_before %}
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                        <div class="bg-blue-600 text-white px-4 py-2 text-center">
                            <h6 class="text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-camera mr-2"></i>Initial Photo
                            </h6>
                        </div>
                        <div class="p-4 text-center">
                            <div class="photo-container">
                                <img src="{{ repair.damage_photo_before.url }}" 
                                     alt="Initial damage photo" 
                                     class="w-full h-auto max-h-80 object-contain rounded-lg shadow-sm cursor-pointer transition-transform duration-200 hover:scale-105"
                                     onclick="openImageModal('{{ repair.damage_photo_before.url }}', 'Initial Damage Photo')">
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Click to view full size</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if repair.damage_photo_after %}
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                        <div class="bg-green-600 text-white px-4 py-2 text-center">
                            <h6 class="text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-check-circle mr-2"></i>Completed Repair
                            </h6>
                        </div>
                        <div class="p-4 text-center">
                            <div class="photo-container">
                                <img src="{{ repair.damage_photo_after.url }}" 
                                     alt="Completed repair photo" 
                                     class="w-full h-auto max-h-80 object-contain rounded-lg shadow-sm cursor-pointer transition-transform duration-200 hover:scale-105"
                                     onclick="openImageModal('{{ repair.damage_photo_after.url }}', 'Completed Repair Photo')">
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Click to view full size</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if not repair.damage_photo_after and repair.queue_status == 'IN_PROGRESS' %}
                <div id="photoReminder" class="mt-4 bg-blue-50 border-l-4 border-blue-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Reminder:</strong> Don't forget to take an "after" photo once the repair is completed for documentation purposes.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Show photo upload reminder when no photos exist -->
            {% if repair.queue_status != 'COMPLETED' %}
            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-amber-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-amber-700">
                            <strong>Photo Documentation:</strong> Consider adding before and after photos to better document this repair. Use the 
                            <a href="{% url 'update_repair' repair.id %}" class="underline font-medium">Edit Repair</a> button to upload photos.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
            
            {% if repair.queue_status == 'REQUESTED' %}
            <div class="alert alert-warning mt-3">
                <h4 class="alert-heading">Customer Requested Repair!</h4>
                <p>This repair was requested directly by the customer. Please review the details and either approve or deny this request.</p>
                <hr>
                <form action="{% url 'update_queue_status' repair.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="APPROVED">
                    <button type="submit" class="btn btn-success">Approve Request</button>
                </form>
                <form action="{% url 'update_queue_status' repair.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="DENIED">
                    <button type="submit" class="btn btn-danger">Deny Request</button>
                </form>
            </div>
            {% endif %}
            
                <!-- Technical Details -->
                {% if repair.drilled_before_repair or repair.windshield_temperature or repair.resin_viscosity %}
                <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200 mb-6">
                    <h4 class="text-lg font-semibold text-indigo-900 mb-3">
                        <i class="fas fa-cogs mr-2"></i>Technical Details
                    </h4>
                    <div class="space-y-2 text-sm">
                        {% if repair.drilled_before_repair %}
                        <div><span class="font-medium text-indigo-700">Drilled Before Repair:</span> <span class="text-indigo-900">Yes</span></div>
                        {% endif %}
                        {% if repair.windshield_temperature %}
                        <div><span class="font-medium text-indigo-700">Windshield Temperature:</span> <span class="text-indigo-900">{{ repair.windshield_temperature }}°F</span></div>
                        {% endif %}
                        {% if repair.resin_viscosity %}
                        <div><span class="font-medium text-indigo-700">Resin Viscosity:</span> <span class="text-indigo-900">{{ repair.resin_viscosity }}</span></div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Applied Rewards -->
                {% if repair.applied_rewards.exists %}
                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200 mb-6">
                    <h4 class="text-lg font-semibold text-purple-900 mb-4">
                        <i class="fas fa-gift mr-2"></i>Applied Rewards
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-purple-200">
                            <thead class="bg-purple-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Reward</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Applied On</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-purple-200">
                                {% for redemption in repair.applied_rewards.all %}
                                <tr>
                                    <td class="px-4 py-2 text-sm text-purple-900">{{ redemption.reward_option.name }}</td>
                                    <td class="px-4 py-2 text-sm text-purple-900">
                                        {% if redemption.reward_option.reward_type %}
                                            {{ redemption.reward_option.reward_type }}
                                        {% else %}
                                            Standard Reward
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-2 text-sm">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                            {% if redemption.status == 'FULFILLED' %}bg-green-100 text-green-800
                                            {% elif redemption.status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ redemption.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-2 text-sm text-purple-900">{{ redemption.processed_at|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
            <!-- Action Buttons Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 rounded-b-lg">
                <div class="flex flex-wrap gap-3 justify-between items-center">
                    <div class="flex flex-wrap gap-3">
                        {% if is_admin %}
                        <!-- Admin can edit any repair regardless of status -->
                        <a href="{% url 'update_repair' repair.id %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            <i class="fas fa-edit mr-2"></i>Edit Repair
                        </a>
                        {% else %}
                        <!-- Regular technicians can only edit repairs that are not in COMPLETED or APPROVED state -->
                        {% if repair.queue_status != 'COMPLETED' and repair.queue_status != 'APPROVED' %}
                        <a href="{% url 'update_repair' repair.id %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            <i class="fas fa-edit mr-2"></i>Edit Repair
                        </a>
                        {% endif %}
                        {% endif %}
                        
                        {% if repair.queue_status == 'PENDING' or repair.queue_status == 'APPROVED' %}
                        <form action="{% url 'update_queue_status' repair.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="IN_PROGRESS">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <i class="fas fa-play mr-2"></i>Start Repair
                            </button>
                        </form>
                        {% endif %}
                        
                        {% if repair.queue_status == 'IN_PROGRESS' %}
                        <form action="{% url 'update_queue_status' repair.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="COMPLETED">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                <i class="fas fa-check mr-2"></i>Mark as Completed
                            </button>
                        </form>
                        {% endif %}

                        <!-- Apply Reward Button -->
                        <a href="{% url 'apply_reward_to_repair' repair.id %}" class="inline-flex items-center px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors">
                            <i class="fas fa-gift mr-2"></i>Apply Reward
                        </a>
                        
                        {% if is_admin %}
                        <div class="relative inline-block text-left">
                            <button type="button" class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors" id="adminActionsDropdown" onclick="toggleDropdown()">
                                <i class="fas fa-cog mr-2"></i>Admin Actions
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div id="dropdownMenu" class="hidden absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                                <div class="py-1">
                                    {% for status, label in repair.QUEUE_CHOICES %}
                                    <form action="{% url 'update_queue_status' repair.id %}" method="post" class="block">
                                        {% csrf_token %}
                                        <input type="hidden" name="status" value="{{ status }}">
                                        <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Set Status: {{ label }}</button>
                                    </form>
                                    {% endfor %}
                                    <div class="border-t border-gray-100"></div>
                                    <a href="{% url 'admin:technician_portal_repair_change' repair.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit in Admin</a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <a href="{% url 'technician_dashboard' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<script>
function openImageModal(imageUrl, title) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('imageModalLabel').textContent = title;
    var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    imageModal.show();
}

function toggleDropdown() {
    const dropdown = document.getElementById('dropdownMenu');
    dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('dropdownMenu');
    const button = document.getElementById('adminActionsDropdown');
    
    if (dropdown && button && !button.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// Photo section toggle functionality
function togglePhotoSection() {
    const photoContent = document.getElementById('photoContent');
    const photoReminder = document.getElementById('photoReminder');
    const toggleIcon = document.getElementById('photoToggleIcon');
    const toggleText = document.getElementById('photoToggleText');
    
    const isVisible = !photoContent.classList.contains('hidden');
    
    if (isVisible) {
        // Hide photos
        photoContent.classList.add('hidden');
        if (photoReminder) photoReminder.classList.add('hidden');
        toggleIcon.className = 'fas fa-chevron-right mr-1';
        toggleText.textContent = 'Show Photos';
        localStorage.setItem('photoSectionCollapsed', 'true');
    } else {
        // Show photos
        photoContent.classList.remove('hidden');
        if (photoReminder) photoReminder.classList.remove('hidden');
        toggleIcon.className = 'fas fa-chevron-down mr-1';
        toggleText.textContent = 'Hide Photos';
        localStorage.setItem('photoSectionCollapsed', 'false');
    }
}

// Initialize photo section state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const photoContent = document.getElementById('photoContent');
    const photoReminder = document.getElementById('photoReminder');
    const toggleIcon = document.getElementById('photoToggleIcon');
    const toggleText = document.getElementById('photoToggleText');
    
    if (photoContent && localStorage.getItem('photoSectionCollapsed') === 'true') {
        photoContent.classList.add('hidden');
        if (photoReminder) photoReminder.classList.add('hidden');
        toggleIcon.className = 'fas fa-chevron-right mr-1';
        toggleText.textContent = 'Show Photos';
    }
});
</script>
{% endblock %}
