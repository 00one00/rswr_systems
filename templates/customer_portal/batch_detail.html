{% extends 'base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Batch Repair Details</h2>

    <div class="mb-4">
        <a href="{% url 'customer_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Batch Summary Card -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-layer-group"></i>
                Unit {{ batch_summary.unit_number }}: {{ batch_summary.break_count }} Breaks
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong>Customer:</strong> {{ batch_summary.customer.name }}</p>
                    <p class="mb-2"><strong>Unit Number:</strong> {{ batch_summary.unit_number }}</p>
                    <p class="mb-2"><strong>Repair Date:</strong> {{ batch_summary.repair_date|date:"M d, Y g:i A" }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-2"><strong>Total Breaks:</strong> {{ batch_summary.break_count }}</p>
                    <p class="mb-2"><strong>Total Cost:</strong> ${{ batch_summary.total_cost|floatformat:2 }}</p>
                    <p class="mb-2">
                        <strong>Status:</strong>
                        <span class="badge {% if batch_summary.current_status == 'COMPLETED' %}bg-success{% elif batch_summary.current_status == 'IN_PROGRESS' %}bg-warning{% elif batch_summary.current_status == 'DENIED' %}bg-danger{% elif batch_summary.current_status == 'PENDING' %}bg-info{% else %}bg-secondary{% endif %}">
                            {{ batch_summary.current_status }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Actions (if any pending repairs) -->
    {% if 'PENDING' in batch_summary.statuses %}
    <div class="card mb-4 bg-light">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-clipboard-check"></i> Batch Actions</h5>
            <p class="text-muted mb-3">Approve or deny all {{ batch_summary.break_count }} breaks at once:</p>

            <div class="btn-group" role="group">
                <a href="{% url 'customer_batch_approve' batch_summary.batch_id %}"
                   class="btn btn-success btn-lg">
                    <i class="fas fa-check-circle"></i> Approve All {{ batch_summary.break_count }} Breaks
                </a>
                <a href="{% url 'customer_batch_deny' batch_summary.batch_id %}"
                   class="btn btn-danger btn-lg">
                    <i class="fas fa-times-circle"></i> Deny Batch
                </a>
            </div>

            <hr class="my-4">

            <p class="text-muted small">
                <strong>Or approve/deny individual breaks:</strong>
                Use the action buttons on each break below to approve or deny them separately.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Individual Breaks -->
    <h4 class="mb-3">Individual Breaks in This Batch</h4>

    {% for repair in repairs %}
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-tools"></i> Break {{ repair.break_number }} of {{ batch_summary.break_count }}
            </h6>
            <span class="badge {% if repair.queue_status == 'COMPLETED' %}bg-success{% elif repair.queue_status == 'IN_PROGRESS' %}bg-warning{% elif repair.queue_status == 'DENIED' %}bg-danger{% elif repair.queue_status == 'PENDING' %}bg-info{% else %}bg-primary{% endif %}">
                {{ repair.get_queue_status_display }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong>Damage Type:</strong> {{ repair.get_damage_type_display }}</p>
                    <p class="mb-2"><strong>Cost:</strong> ${{ repair.cost|floatformat:2 }}</p>
                    {% if repair.cost_override %}
                    <p class="mb-2 text-warning">
                        <strong><i class="fas fa-dollar-sign"></i> Manager Price Override:</strong> Applied
                    </p>
                    {% endif %}
                    {% if repair.override_reason %}
                    <p class="mb-2 text-muted small">
                        <strong>Override Reason:</strong> {{ repair.override_reason }}
                    </p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if repair.windshield_temperature %}
                    <p class="mb-2"><strong><i class="fas fa-thermometer-half"></i> Temperature:</strong> {{ repair.windshield_temperature }}Â°F</p>
                    {% endif %}
                    {% if repair.resin_viscosity %}
                    <p class="mb-2"><strong><i class="fas fa-droplet"></i> Resin Viscosity:</strong> {{ repair.resin_viscosity }}</p>
                    {% endif %}
                    {% if repair.drilled_before_repair %}
                    <p class="mb-2"><strong><i class="fas fa-check-circle text-success"></i> Pre-drilled</strong></p>
                    {% endif %}
                </div>
            </div>

            {% if repair.notes %}
            <div class="mt-3">
                <strong>Technician Notes:</strong>
                <p class="text-muted">{{ repair.notes }}</p>
            </div>
            {% endif %}

            <!-- Photos -->
            {% if repair.damage_photo_before or repair.damage_photo_after %}
            <div class="mt-3">
                <strong>Photos:</strong>
                <div class="row mt-2">
                    {% if repair.damage_photo_before %}
                    <div class="col-md-6 mb-2">
                        <p class="small text-muted">Before:</p>
                        <img src="{{ repair.damage_photo_before.url }}"
                             alt="Before"
                             class="img-fluid rounded"
                             style="max-height: 300px;"
                             loading="lazy"
                             decoding="async">
                    </div>
                    {% endif %}
                    {% if repair.damage_photo_after %}
                    <div class="col-md-6 mb-2">
                        <p class="small text-muted">After:</p>
                        <img src="{{ repair.damage_photo_after.url }}"
                             alt="After"
                             class="img-fluid rounded"
                             style="max-height: 300px;"
                             loading="lazy"
                             decoding="async">
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Individual Actions (if pending) -->
            {% if repair.queue_status == 'PENDING' %}
            <div class="mt-3 border-top pt-3">
                <p class="text-muted small mb-2"><strong>Individual Break Actions:</strong></p>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="{% url 'customer_repair_approve' repair.id %}" class="btn btn-outline-success">
                        <i class="fas fa-check"></i> Approve This Break
                    </a>
                    <a href="{% url 'customer_repair_deny' repair.id %}" class="btn btn-outline-danger">
                        <i class="fas fa-times"></i> Deny This Break
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Back to Dashboard -->
    <div class="mt-4 text-center">
        <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary">
            <i class="fa fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
