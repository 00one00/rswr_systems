{% extends "base.html" %}
{% load static %}

{% block title %}Account Settings - RS Systems{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Tooltip System */
.tooltip-trigger {
    position: relative;
    display: inline-flex;
    align-items: center;
    cursor: help;
    color: #6b7280;
    transition: color 0.2s;
}

.tooltip-trigger:hover {
    color: #2563eb;
}

.tooltip-content {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background-color: #1f2937;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    line-height: 1.4;
    white-space: normal;
    width: max-content;
    max-width: 280px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 50;
    pointer-events: none;
}

.tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #1f2937;
}

.tooltip-trigger:hover .tooltip-content {
    opacity: 1;
    visibility: visible;
}

/* Tab Styles */
.tab-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-bottom: 2px solid transparent;
    color: #6b7280;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
}

.tab-button:hover {
    color: #2563eb;
    background-color: #eff6ff;
}

.tab-button.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    background-color: #eff6ff;
}

/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.form-input {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    background-color: white;
}

.form-input:focus {
    outline: none;
    border-color: #2563eb;
    ring: 2px;
    ring-color: rgba(37, 99, 235, 0.1);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input:disabled {
    background-color: #f9fafb;
    color: #9ca3af;
    cursor: not-allowed;
}

/* Radio and Checkbox Styles */
.radio-group, .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.radio-option, .checkbox-option {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
}

.radio-option:hover, .checkbox-option:hover {
    border-color: #2563eb;
    background-color: #eff6ff;
}

.radio-option input[type="radio"]:checked ~ label,
.checkbox-option input[type="checkbox"]:checked ~ label {
    color: #2563eb;
}

/* Smooth transitions for conditional sections */
.conditional-section {
    transition: all 0.3s ease;
    overflow: hidden;
}

.conditional-section.hidden {
    max-height: 0;
    opacity: 0;
    margin: 0;
    padding: 0;
}

.conditional-section.visible {
    max-height: 1000px;
    opacity: 1;
}

/* Badge Styles */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-warning {
    background-color: #fef3c7;
    color: #92400e;
}

.badge-info {
    background-color: #dbeafe;
    color: #1e40af;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Account Settings</h1>
                    <p class="text-gray-600 mt-1">Manage your profile, preferences, and security</p>
                </div>
                <a href="{% url 'customer_dashboard' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="border-b border-gray-200">
                <div class="flex">
                    <button type="button" class="tab-button active" data-tab="personal">
                        <i class="fas fa-user"></i>
                        <span>Personal Info</span>
                    </button>
                    <button type="button" class="tab-button" data-tab="repair">
                        <i class="fas fa-sliders"></i>
                        <span>Repair Preferences</span>
                    </button>
                    <button type="button" class="tab-button" data-tab="security">
                        <i class="fas fa-shield-alt"></i>
                        <span>Security</span>
                    </button>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}

                <!-- Personal Info Tab -->
                <div class="tab-content p-6" id="personal-tab" style="display: block;">
                    <!-- User Information Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 text-blue-600 p-2 rounded-lg">
                                    <i class="fas fa-user text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Personal Information</h3>
                                    <p class="text-sm text-gray-600">Update your name and email address</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="first_name" class="form-label">
                                    <i class="fas fa-user text-gray-400"></i>
                                    First Name
                                </label>
                                <input type="text" class="form-input" id="first_name" name="first_name" value="{{ request.user.first_name }}" required>
                            </div>

                            <div class="form-group">
                                <label for="last_name" class="form-label">
                                    <i class="fas fa-user text-gray-400"></i>
                                    Last Name
                                </label>
                                <input type="text" class="form-input" id="last_name" name="last_name" value="{{ request.user.last_name }}" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope text-gray-400"></i>
                                Email Address
                            </label>
                            <input type="email" class="form-input" id="email" name="email" value="{{ request.user.email }}" required>
                        </div>
                    </div>

                    <!-- Company Role Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 text-green-600 p-2 rounded-lg">
                                    <i class="fas fa-building text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Company Role</h3>
                                    <p class="text-sm text-gray-600">Manage your role within your organization</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-lg">
                            <input type="checkbox" class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" id="is_primary_contact" name="is_primary_contact" {% if customer_user.is_primary_contact %}checked{% endif %}>
                            <div class="flex-1">
                                <label for="is_primary_contact" class="text-sm font-medium text-gray-900 cursor-pointer">
                                    I am the primary contact for this company
                                </label>
                                <p class="text-xs text-gray-600 mt-1">Primary contacts receive important notifications and approvals</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repair Preferences Tab -->
                <div class="tab-content p-6" id="repair-tab" style="display: none;">
                    <!-- Approval Settings Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-yellow-100 text-yellow-600 p-2 rounded-lg">
                                    <i class="fas fa-clipboard-check text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                        Field Repair Approval Mode
                                        <span class="tooltip-trigger">
                                            <i class="fas fa-circle-question text-sm"></i>
                                            <span class="tooltip-content">
                                                Configure how field repairs discovered during lot walking should be handled
                                            </span>
                                        </span>
                                    </h3>
                                    <p class="text-sm text-gray-600">Choose how field-discovered repairs are approved</p>
                                </div>
                            </div>
                        </div>

                        <div class="radio-group">
                            {% for radio in repair_form.field_repair_approval_mode %}
                            <label class="radio-option">
                                {{ radio.tag }}
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">{{ radio.choice_label }}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        {% if 'Auto-approve all' in radio.choice_label %}
                                        Technicians can complete repairs without waiting for approval
                                        {% elif 'Require approval' in radio.choice_label %}
                                        You'll review and approve each field repair before work begins
                                        {% elif 'threshold' in radio.choice_label %}
                                        Auto-approve repairs up to a set limit per visit
                                        {% endif %}
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>

                        <!-- Threshold Setting (Conditional) -->
                        <div id="threshold-setting" class="conditional-section hidden mt-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <label for="{{ repair_form.units_per_visit_threshold.id_for_label }}" class="form-label flex items-center gap-2">
                                    <i class="fas fa-hashtag text-blue-600"></i>
                                    Units Per Visit Threshold
                                    <span class="tooltip-trigger">
                                        <i class="fas fa-circle-question text-sm"></i>
                                        <span class="tooltip-content">
                                            Max number of units technician can repair per visit without approval
                                        </span>
                                    </span>
                                </label>
                                <input type="number" class="form-input max-w-xs" id="{{ repair_form.units_per_visit_threshold.id_for_label }}" name="{{ repair_form.units_per_visit_threshold.name }}" value="{{ repair_form.units_per_visit_threshold.value|default:5 }}" min="1" max="50">
                            </div>
                        </div>
                    </div>

                    <!-- Lot Walking Schedule Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 text-green-600 p-2 rounded-lg">
                                    <i class="fas fa-calendar-alt text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                        Lot Walking Schedule
                                        <span class="tooltip-trigger">
                                            <i class="fas fa-circle-question text-sm"></i>
                                            <span class="tooltip-content">
                                                Schedule regular lot inspections to proactively find and fix damage
                                            </span>
                                        </span>
                                    </h3>
                                    <p class="text-sm text-gray-600">Configure scheduled lot walking service</p>
                                </div>
                            </div>
                        </div>

                        <!-- Enable Toggle -->
                        <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-lg mb-4">
                            <div class="flex items-center h-5">
                                <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" id="{{ repair_form.lot_walking_enabled.id_for_label }}" name="{{ repair_form.lot_walking_enabled.name }}" {% if repair_form.lot_walking_enabled.value %}checked{% endif %}>
                            </div>
                            <div class="flex-1">
                                <label for="{{ repair_form.lot_walking_enabled.id_for_label }}" class="text-sm font-medium text-gray-900 cursor-pointer">
                                    Enable Lot Walking Service
                                </label>
                                <p class="text-xs text-gray-600 mt-1">Regular inspections help catch damage early</p>
                            </div>
                        </div>

                        <!-- Lot Walking Details (Conditional) -->
                        <div id="lot-walking-details" class="conditional-section hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-5 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Frequency -->
                                    <div class="form-group">
                                        <label for="{{ repair_form.lot_walking_frequency.id_for_label }}" class="form-label">
                                            <i class="fas fa-sync text-green-600"></i>
                                            Frequency
                                        </label>
                                        <select class="form-input" id="{{ repair_form.lot_walking_frequency.id_for_label }}" name="{{ repair_form.lot_walking_frequency.name }}">
                                            {% for value, label in repair_form.lot_walking_frequency.field.choices %}
                                            <option value="{{ value }}" {% if repair_form.lot_walking_frequency.value == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Preferred Time -->
                                    <div class="form-group">
                                        <label for="{{ repair_form.lot_walking_time.id_for_label }}" class="form-label">
                                            <i class="fas fa-clock text-green-600"></i>
                                            Preferred Time
                                        </label>
                                        <input type="time" class="form-input" id="{{ repair_form.lot_walking_time.id_for_label }}" name="{{ repair_form.lot_walking_time.name }}" value="{{ repair_form.lot_walking_time.value|default:'' }}">
                                    </div>
                                </div>

                                <!-- Preferred Days -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-week text-green-600"></i>
                                        Preferred Days
                                    </label>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {% for checkbox in repair_form.lot_walking_days_choices %}
                                        <label class="flex items-center gap-2 p-3 bg-white border border-green-200 rounded-lg cursor-pointer hover:bg-green-50 transition-colors">
                                            {{ checkbox.tag }}
                                            <span class="text-sm text-gray-700">{{ checkbox.choice_label }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-content p-6" id="security-tab" style="display: none;">
                    <!-- Password Change Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-100 text-red-600 p-2 rounded-lg">
                                    <i class="fas fa-lock text-xl"></i>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-lg font-semibold text-gray-900">Change Password</h3>
                                        <span class="badge badge-info">Optional</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Update your account password for security</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex gap-3">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                <div class="text-sm text-blue-900">
                                    <p class="font-medium">Leave all password fields blank if you don't want to change your password.</p>
                                    <p class="mt-1 text-blue-800">Your password must be at least 8 characters long and include a mix of letters and numbers for security.</p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label for="current_password" class="form-label">
                                    <i class="fas fa-key text-gray-400"></i>
                                    Current Password
                                </label>
                                <input type="password" class="form-input" id="current_password" name="current_password" placeholder="Enter your current password">
                            </div>

                            <div class="form-group">
                                <label for="new_password" class="form-label">
                                    <i class="fas fa-lock text-gray-400"></i>
                                    New Password
                                    <span class="tooltip-trigger ml-1">
                                        <i class="fas fa-circle-question text-sm"></i>
                                        <span class="tooltip-content">
                                            Must be at least 8 characters long with letters and numbers
                                        </span>
                                    </span>
                                </label>
                                <input type="password" class="form-input" id="new_password" name="new_password" placeholder="Enter your new password">
                            </div>

                            <div class="form-group">
                                <label for="confirm_password" class="form-label">
                                    <i class="fas fa-lock text-gray-400"></i>
                                    Confirm New Password
                                </label>
                                <input type="password" class="form-input" id="confirm_password" name="confirm_password" placeholder="Re-enter your new password">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="p-6 bg-gray-50 border-t border-gray-200 flex items-center justify-between gap-4">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-save text-gray-400 mr-1"></i>
                        Changes will be saved to your account
                    </p>
                    <div class="flex gap-3">
                        <a href="{% url 'customer_dashboard' %}" class="inline-flex items-center px-5 py-2.5 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </a>
                        <button type="submit" class="inline-flex items-center px-6 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors shadow-sm">
                            <i class="fas fa-check mr-2"></i>
                            Save All Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab Switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');

            // Remove active class from all buttons
            tabButtons.forEach(btn => btn.classList.remove('active'));

            // Add active class to clicked button
            this.classList.add('active');

            // Hide all tab contents
            tabContents.forEach(content => {
                content.style.display = 'none';
            });

            // Show target tab content
            const targetContent = document.getElementById(targetTab + '-tab');
            if (targetContent) {
                targetContent.style.display = 'block';
            }
        });
    });

    // Threshold Setting Visibility
    const approvalModeRadios = document.querySelectorAll('input[name="field_repair_approval_mode"]');
    const thresholdSetting = document.getElementById('threshold-setting');

    function updateThresholdVisibility() {
        const selectedMode = document.querySelector('input[name="field_repair_approval_mode"]:checked');
        if (selectedMode && selectedMode.value === 'UNIT_THRESHOLD') {
            thresholdSetting.classList.remove('hidden');
            thresholdSetting.classList.add('visible');
        } else {
            thresholdSetting.classList.add('hidden');
            thresholdSetting.classList.remove('visible');
        }
    }

    approvalModeRadios.forEach(radio => {
        radio.addEventListener('change', updateThresholdVisibility);
    });

    // Initial check
    updateThresholdVisibility();

    // Lot Walking Details Visibility
    const lotWalkingEnabled = document.getElementById('{{ repair_form.lot_walking_enabled.id_for_label }}');
    const lotWalkingDetails = document.getElementById('lot-walking-details');

    function updateLotWalkingVisibility() {
        if (lotWalkingEnabled && lotWalkingDetails) {
            if (lotWalkingEnabled.checked) {
                lotWalkingDetails.classList.remove('hidden');
                lotWalkingDetails.classList.add('visible');
            } else {
                lotWalkingDetails.classList.add('hidden');
                lotWalkingDetails.classList.remove('visible');
            }
        }
    }

    if (lotWalkingEnabled) {
        lotWalkingEnabled.addEventListener('change', updateLotWalkingVisibility);
        // Initial check
        updateLotWalkingVisibility();
    }

    // Radio Button Styling - Add checked class to parent
    const radioInputs = document.querySelectorAll('.radio-option input[type="radio"]');
    radioInputs.forEach(radio => {
        radio.addEventListener('change', function() {
            // Remove checked class from all radio options in the same group
            const groupName = this.getAttribute('name');
            document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
                r.closest('.radio-option')?.classList.remove('border-blue-500', 'bg-blue-50');
            });

            // Add checked class to selected option
            if (this.checked) {
                this.closest('.radio-option')?.classList.add('border-blue-500', 'bg-blue-50');
            }
        });

        // Set initial state
        if (radio.checked) {
            radio.closest('.radio-option')?.classList.add('border-blue-500', 'bg-blue-50');
        }
    });

    // Smooth scroll to validation errors if any
    const firstError = document.querySelector('.alert-error');
    if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});
</script>
{% endblock %}
