{% extends "base.html" %}
{% load static %}

{% block title %}Customer Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard_visualizations.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome, {{ customer.name }}</h1>
    </div>
    
    <!-- Add data visualization section at the top of the dashboard -->
    <div class="visualizations-container">
        <h2>Repair Analytics</h2>
        <div class="charts-container">
            <div class="chart-card">
                <h3>Repair Status Distribution</h3>
                <div id="status-chart"></div>
            </div>
            <div class="chart-card">
                <h3>Repairs by Unit</h3>
                <div id="unit-chart"></div>
            </div>
            <div class="chart-card">
                <h3>Repair Frequency Over Time</h3>
                <div id="cost-chart"></div>
            </div>
        </div>
    </div>
    
    <!-- Stats summary cards section -->
    <div class="stats-container">
        <div class="row">
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">Active Repairs</h5>
                        <p class="display-4">{{ active_repairs_count|default:"0" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-success mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">Completed</h5>
                        <p class="display-4">{{ completed_repairs_count|default:"0" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">Awaiting Approval</h5>
                        <p class="display-4">{{ pending_approval_count|default:"0" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Company Information -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Company Information</h5>
                    <a href="{% url 'edit_company' %}" class="btn btn-sm btn-outline-primary">Edit</a>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>Name:</strong> {{ customer.name|title }}</p>
                    <p class="mb-1"><strong>Email:</strong> {{ customer.email }}</p>
                    <p class="mb-1"><strong>Phone:</strong> {{ customer.phone }}</p>
                    <p class="mb-1"><strong>Address:</strong> {{ customer.address }}</p>
                    {% if customer.city or customer.state %}
                    <p class="mb-1"><strong>Location:</strong> {{ customer.city|default:"" }}, {{ customer.state|default:"" }} {{ customer.zip_code|default:"" }}</p>
                    {% endif %}
                    <p class="mb-0">
                        <strong>Primary Contact:</strong> {{ request.user.first_name }} {{ request.user.last_name }}
                        {% if customer_user.is_primary_contact %}
                        <span class="badge bg-primary">Primary Contact</span>
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'customer_repairs' %}" class="btn btn-primary">
                            <i class="fa fa-list"></i> View All Repairs
                        </a>
                        <a href="{% url 'request_repair' %}" class="btn btn-outline-primary">
                            <i class="fa fa-wrench"></i> Request New Repair
                        </a>
                        <a href="{% url 'account_settings' %}" class="btn btn-outline-secondary">
                            <i class="fa fa-cog"></i> Account Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Repairs and Notifications -->
        <div class="col-md-8">
            <!-- Recent Repairs -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Repairs</h5>
                    <a href="{% url 'customer_repairs' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    {% if recent_repairs %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for repair in recent_repairs %}
                                <tr>
                                    <td>#{{ repair.id }}</td>
                                    <td>{{ repair.repair_date|date:"M d, Y" }}</td>
                                    <td>{{ repair.description|truncatechars:30 }}</td>
                                    <td>
                                        <span class="badge {% if repair.queue_status == 'COMPLETED' %}bg-success{% elif repair.queue_status == 'IN_PROGRESS' %}bg-warning{% elif repair.queue_status == 'REQUESTED' %}bg-secondary{% elif repair.queue_status == 'APPROVED' %}bg-info{% else %}bg-primary{% endif %}">
                                            {% if repair.queue_status == 'REQUESTED' %}
                                            Submitted - Awaiting Technician
                                            {% elif repair.queue_status == 'APPROVED' and repair.customer_initiated %}
                                            Scheduled for Repair
                                            {% else %}
                                            {{ repair.get_queue_status_display }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'customer_repair_detail' repair.id %}" class="btn btn-sm btn-primary">View</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="mb-0 text-muted">No recent repairs found.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Repairs Awaiting Approval -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Repairs Awaiting Your Approval</h5>
                </div>
                <div class="card-body">
                    {% if pending_approval_repairs %}
                    <div class="list-group">
                        {% for repair in pending_approval_repairs %}
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Repair #{{ repair.id }}: {{ repair.description|truncatechars:50 }}</h6>
                                <small>{{ repair.repair_date|date:"M d, Y" }}</small>
                            </div>
                            <p class="mb-1">
                                {% if repair.cost %}
                                Estimated cost: ${{ repair.cost }}
                                {% endif %}
                            </p>
                            <div class="d-flex justify-content-end mt-2">
                                <a href="{% url 'customer_repair_detail' repair.id %}" class="btn btn-sm btn-outline-primary me-2">Details</a>
                                <a href="{% url 'customer_repair_approve' repair.id %}" class="btn btn-sm btn-success">Approve</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center mb-0">No repairs waiting for approval.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load D3.js from CDN -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Extract data from the Django template context for visualizations
        const repairData = {
            statuses: [
                {status: 'Requested', count: {{ stats.repairs_requested|default:0 }}},
                {status: 'Pending', count: {{ stats.repairs_pending|default:0 }}},
                {status: 'Approved', count: {{ stats.repairs_approved|default:0 }}},
                {status: 'In Progress', count: {{ stats.repairs_in_progress|default:0 }}},
                {status: 'Completed', count: {{ stats.repairs_completed|default:0 }}},
                {status: 'Denied', count: {{ stats.repairs_denied|default:0 }}}
            ]
        };
        
        // Create a color scale for the pie chart
        const colorScale = d3.scaleOrdinal()
            .domain(['Requested', 'Pending', 'Approved', 'In Progress', 'Completed', 'Denied'])
            .range(['#F9CA3F', '#3498DB', '#2ECC71', '#9B59B6', '#1ABC9C', '#E74C3C']);
        
        // Function to create the status pie chart
        function createStatusChart() {
            // Filter out statuses with 0 count
            const data = repairData.statuses.filter(function(d) {
                return d.count > 0;
            });
            
            if (data.length === 0) {
                d3.select('#status-chart').append('p')
                    .text('No repair data available');
                return;
            }
            
            // Dimensions
            const width = 300;
            const height = 300;
            const margin = 40;
            const radius = Math.min(width, height) / 2 - margin;
            
            // Create SVG
            const svg = d3.select('#status-chart')
                .append('svg')
                .attr('width', width + 120)
                .attr('height', height)
                .append('g')
                .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');
            
            // Create pie layout
            const pie = d3.pie()
                .value(function(d) { return d.count; });
            
            // Generate arc
            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);
            
            // Generate the pie chart
            const path = svg.selectAll('path')
                .data(pie(data))
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', function(d) { return colorScale(d.data.status); })
                .attr('stroke', 'white')
                .style('stroke-width', '2px')
                .style('opacity', 0.8);
            
            // Add tooltips
            path.append('title')
                .text(function(d) { return d.data.status + ': ' + d.data.count; });
            
            // Add a legend
            const legend = svg.selectAll('.legend')
                .data(data)
                .enter()
                .append('g')
                .attr('class', 'legend')
                .attr('transform', function(d, i) { 
                    return 'translate(' + (radius + 10) + ',' + (i * 20 - data.length * 10) + ')'; 
                });
            
            legend.append('rect')
                .attr('width', 12)
                .attr('height', 12)
                .attr('fill', function(d) { return colorScale(d.status); });
            
            legend.append('text')
                .attr('x', 20)
                .attr('y', 10)
                .text(function(d) { return d.status + ' (' + d.count + ')'; })
                .style('font-size', '12px');
        }
        
        // Function to load unit repair data via AJAX and create bar chart
        function loadUnitDataAndCreateChart() {
            fetch('/customer/api/unit-repair-data/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    repairData.unitCounts = data;
                    createUnitChart();
                })
                .catch(function(error) {
                    console.error('Error loading unit data:', error);
                    d3.select('#unit-chart').append('p')
                        .text('Error loading unit repair data');
                });
        }
        
        // Function to create the unit repair count bar chart
        function createUnitChart() {
            if (!repairData.unitCounts || repairData.unitCounts.length === 0) {
                d3.select('#unit-chart').append('p')
                    .text('No unit repair data available');
                return;
            }
            
            // Sort by repair count (descending)
            const data = repairData.unitCounts.sort(function(a, b) {
                return b.count - a.count;
            }).slice(0, 10);
            
            // Dimensions
            const margin = {top: 20, right: 20, bottom: 60, left: 40};
            const width = 400 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;
            
            // Create SVG
            const svg = d3.select('#unit-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
            
            // X scale
            const x = d3.scaleBand()
                .domain(data.map(function(d) { return d.unit_number; }))
                .range([0, width])
                .padding(0.2);
            
            // Y scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, function(d) { return d.count; }) + 1])
                .range([height, 0]);
            
            // Add X axis
            svg.append('g')
                .attr('transform', 'translate(0,' + height + ')')
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'translate(-10,0)rotate(-45)')
                .style('text-anchor', 'end');
            
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(y));
            
            // Create bars
            svg.selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', function(d) { return x(d.unit_number); })
                .attr('y', function(d) { return y(d.count); })
                .attr('width', x.bandwidth())
                .attr('height', function(d) { return height - y(d.count); })
                .attr('fill', '#3498DB');
            
            // Add axes labels
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', height + margin.bottom - 10)
                .text('Unit Number');
            
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'translate(' + (-margin.left/2) + ',' + (height/2) + ')rotate(-90)')
                .text('Repair Count');
        }
        
        // Function to load cost data and create line chart
        function loadCostDataAndCreateChart() {
            fetch('/customer/api/repair-cost-data/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    repairData.costData = data;
                    createCostChart();
                })
                .catch(function(error) {
                    console.error('Error loading cost data:', error);
                    d3.select('#cost-chart').append('p')
                        .text('Error loading repair cost data');
                });
        }
        
        // Function to create the cost over time line chart
        function createCostChart() {
            if (!repairData.costData || repairData.costData.length === 0) {
                d3.select('#cost-chart').append('p')
                    .text('No frequency data available');
                return;
            }
            
            // Sort by date
            const data = repairData.costData.sort(function(a, b) {
                return new Date(a.date) - new Date(b.date);
            });
            
            // Dimensions
            const margin = {top: 20, right: 30, bottom: 50, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;
            
            // Create SVG
            const svg = d3.select('#cost-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
            
            // X scale (time)
            const x = d3.scaleTime()
                .domain(d3.extent(data, function(d) { return new Date(d.date); }))
                .range([0, width]);
            
            // Y scale (count)
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, function(d) { return d.count; }) * 1.1])
                .range([height, 0]);
            
            // Create line generator
            const line = d3.line()
                .x(function(d) { return x(new Date(d.date)); })
                .y(function(d) { return y(d.count); })
                .curve(d3.curveMonotoneX);
            
            // Add X axis
            svg.append('g')
                .attr('transform', 'translate(0,' + height + ')')
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%b %Y')))
                .selectAll('text')
                .attr('transform', 'translate(-10,0)rotate(-45)')
                .style('text-anchor', 'end');
            
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(y).tickFormat(function(d) { return d; }));
            
            // Add the line path
            svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#E74C3C')
                .attr('stroke-width', 2)
                .attr('d', line);
            
            // Add dots for each data point
            svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', function(d) { return x(new Date(d.date)); })
                .attr('cy', function(d) { return y(d.count); })
                .attr('r', 5)
                .attr('fill', '#E74C3C')
                .attr('stroke', 'white')
                .attr('stroke-width', 1.5);
            
            // Add axes labels
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', height + margin.bottom - 10)
                .text('Date');
            
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', 'translate(' + (-margin.left/2) + ',' + (height/2) + ')rotate(-90)')
                .text('Repair Count');
        }
        
        // Initialize charts
        createStatusChart();
        loadUnitDataAndCreateChart();
        loadCostDataAndCreateChart();
    });
</script>
{% endblock %}
