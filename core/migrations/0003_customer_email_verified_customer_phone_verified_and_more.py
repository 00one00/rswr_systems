# Generated by Django 5.1.2 on 2025-11-29 22:26

import django.core.validators
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('contenttypes', '0002_remove_content_type_name'),
        ('core', '0002_alter_customer_options'),
        ('technician_portal', '0017_technician_email_verified_technician_phone_verified_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='customer',
            name='email_verified',
            field=models.BooleanField(default=False, help_text='Whether email address has been verified'),
        ),
        migrations.AddField(
            model_name='customer',
            name='phone_verified',
            field=models.BooleanField(default=False, help_text='Whether phone number has been verified'),
        ),
        migrations.AlterField(
            model_name='customer',
            name='phone',
            field=models.CharField(blank=True, help_text='Contact phone number in E.164 format (e.g., +12025551234)', max_length=20, null=True, validators=[django.core.validators.RegexValidator(message="Phone number must be entered in format: '+999999999'. Up to 15 digits allowed.", regex='^\\+?1?\\d{9,15}$')]),
        ),
        migrations.CreateModel(
            name='CustomerNotificationPreference',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('receive_email_notifications', models.BooleanField(default=True, help_text='Receive email notifications (MEDIUM/URGENT priority)')),
                ('receive_sms_notifications', models.BooleanField(default=False, help_text='Receive SMS notifications (HIGH/URGENT priority)')),
                ('receive_in_app_notifications', models.BooleanField(default=True, help_text='Show in-app notifications (cannot disable URGENT)')),
                ('notify_repair_status', models.BooleanField(default=True, help_text='Notifications for repair status changes')),
                ('notify_assignments', models.BooleanField(default=True, help_text='Notifications for repair assignments/reassignments')),
                ('notify_approvals', models.BooleanField(default=True, help_text='Notifications for approvals/denials (URGENT - cannot fully disable)')),
                ('notify_rewards', models.BooleanField(default=True, help_text='Notifications for rewards and referrals')),
                ('notify_system', models.BooleanField(default=True, help_text='System notifications and announcements')),
                ('quiet_hours_enabled', models.BooleanField(default=False, help_text='Enable quiet hours for non-urgent notifications')),
                ('quiet_hours_start', models.TimeField(blank=True, help_text='Start of quiet hours (e.g., 22:00)', null=True)),
                ('quiet_hours_end', models.TimeField(blank=True, help_text='End of quiet hours (e.g., 08:00)', null=True)),
                ('email_verified', models.BooleanField(default=False, help_text='Whether email address has been verified')),
                ('email_verified_at', models.DateTimeField(blank=True, help_text='When email was verified', null=True)),
                ('phone_verified', models.BooleanField(default=False, help_text='Whether phone number has been verified')),
                ('phone_verified_at', models.DateTimeField(blank=True, help_text='When phone was verified', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('notify_new_requests', models.BooleanField(default=True, help_text='Get notified when repair requests are submitted')),
                ('notify_pending_approvals', models.BooleanField(default=True, help_text='Get notified when repairs need approval')),
                ('notify_completions', models.BooleanField(default=True, help_text='Get notified when repairs are completed')),
                ('notify_in_progress', models.BooleanField(default=True, help_text='Get notified when repairs start')),
                ('batch_pending_approvals', models.BooleanField(default=False, help_text='Receive one notification for all pending approvals (daily)')),
                ('customer', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='notification_preferences', to='core.customer')),
            ],
            options={
                'verbose_name': 'Customer Notification Preference',
                'verbose_name_plural': 'Customer Notification Preferences',
            },
        ),
        migrations.CreateModel(
            name='NotificationTemplate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text="Internal name for the template (e.g., 'repair_approved')", max_length=100, unique=True)),
                ('description', models.TextField(help_text='Description of when this template is used')),
                ('category', models.CharField(choices=[('repair_status', 'Repair Status Change'), ('assignment', 'Assignment/Reassignment'), ('approval', 'Approval/Denial'), ('reward', 'Reward/Referral'), ('system', 'System Notification')], help_text='Notification category this template belongs to', max_length=50)),
                ('default_priority', models.CharField(choices=[('URGENT', 'Urgent - SMS + Email'), ('HIGH', 'High - SMS'), ('MEDIUM', 'Medium - Email'), ('LOW', 'Low - In-app only')], default='MEDIUM', max_length=20)),
                ('title_template', models.CharField(help_text='Template for notification title (Django template syntax)', max_length=200)),
                ('message_template', models.TextField(help_text='Template for in-app message (supports markdown and Django template syntax)')),
                ('email_subject_template', models.CharField(blank=True, help_text='Email subject line template (plain text)', max_length=200)),
                ('email_html_template', models.TextField(blank=True, help_text='HTML email body template (full HTML with Django template syntax)')),
                ('email_text_template', models.TextField(blank=True, help_text='Plain text email body template (fallback for non-HTML clients)')),
                ('sms_template', models.CharField(blank=True, help_text='SMS message template (max 160 chars after rendering)', max_length=160)),
                ('action_url_template', models.CharField(blank=True, help_text="URL template for notification action (e.g., '/tech/repairs/{{ repair.id }}/')", max_length=500)),
                ('active', models.BooleanField(default=True, help_text='Whether this template is currently active')),
                ('version', models.PositiveIntegerField(default=1, help_text='Template version for tracking changes')),
                ('required_context', models.JSONField(default=list, help_text="List of required context variable names (e.g., ['repair', 'customer'])")),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_templates', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Notification Template',
                'verbose_name_plural': 'Notification Templates',
                'ordering': ['category', 'name'],
            },
        ),
        migrations.CreateModel(
            name='Notification',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('recipient_id', models.PositiveIntegerField(help_text='The ID of the recipient object')),
                ('title', models.CharField(help_text='Short notification title (shown in list views)', max_length=200)),
                ('message', models.TextField(help_text='Full notification message (supports markdown)')),
                ('category', models.CharField(choices=[('repair_status', 'Repair Status Change'), ('assignment', 'Assignment/Reassignment'), ('approval', 'Approval/Denial'), ('reward', 'Reward/Referral'), ('system', 'System Notification')], db_index=True, help_text='Category for filtering and preference management', max_length=50)),
                ('priority', models.CharField(choices=[('URGENT', 'Urgent - SMS + Email'), ('HIGH', 'High - SMS'), ('MEDIUM', 'Medium - Email'), ('LOW', 'Low - In-app only')], db_index=True, help_text='Priority level determines delivery channels', max_length=20)),
                ('read', models.BooleanField(db_index=True, default=False, help_text='Whether recipient has marked as read')),
                ('read_at', models.DateTimeField(blank=True, help_text='Timestamp when notification was read', null=True)),
                ('email_sent', models.BooleanField(default=False, help_text='Whether email was successfully sent')),
                ('sms_sent', models.BooleanField(default=False, help_text='Whether SMS was successfully sent')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('scheduled_for', models.DateTimeField(blank=True, help_text='Optional: schedule notification for future delivery', null=True)),
                ('repair_batch_id', models.UUIDField(blank=True, db_index=True, help_text='Link to batch of repairs if applicable', null=True)),
                ('template_context', models.JSONField(blank=True, default=dict, help_text='Context data used with template (stored for audit)')),
                ('action_url', models.CharField(blank=True, help_text='URL to navigate to when notification clicked', max_length=500)),
                ('customer', models.ForeignKey(blank=True, help_text='Link to customer if applicable', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='notification_records', to='core.customer')),
                ('recipient_type', models.ForeignKey(help_text='The type of recipient (User, CustomerUser, Technician)', on_delete=django.db.models.deletion.CASCADE, to='contenttypes.contenttype')),
                ('repair', models.ForeignKey(blank=True, help_text='Link to related repair if applicable', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='notification_records', to='technician_portal.repair')),
                ('template', models.ForeignKey(blank=True, help_text='Optional: template used to generate this notification', null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.notificationtemplate')),
            ],
            options={
                'verbose_name': 'Notification',
                'verbose_name_plural': 'Notifications',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TechnicianNotificationPreference',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('receive_email_notifications', models.BooleanField(default=True, help_text='Receive email notifications (MEDIUM/URGENT priority)')),
                ('receive_sms_notifications', models.BooleanField(default=False, help_text='Receive SMS notifications (HIGH/URGENT priority)')),
                ('receive_in_app_notifications', models.BooleanField(default=True, help_text='Show in-app notifications (cannot disable URGENT)')),
                ('notify_repair_status', models.BooleanField(default=True, help_text='Notifications for repair status changes')),
                ('notify_assignments', models.BooleanField(default=True, help_text='Notifications for repair assignments/reassignments')),
                ('notify_approvals', models.BooleanField(default=True, help_text='Notifications for approvals/denials (URGENT - cannot fully disable)')),
                ('notify_rewards', models.BooleanField(default=True, help_text='Notifications for rewards and referrals')),
                ('notify_system', models.BooleanField(default=True, help_text='System notifications and announcements')),
                ('quiet_hours_enabled', models.BooleanField(default=False, help_text='Enable quiet hours for non-urgent notifications')),
                ('quiet_hours_start', models.TimeField(blank=True, help_text='Start of quiet hours (e.g., 22:00)', null=True)),
                ('quiet_hours_end', models.TimeField(blank=True, help_text='End of quiet hours (e.g., 08:00)', null=True)),
                ('email_verified', models.BooleanField(default=False, help_text='Whether email address has been verified')),
                ('email_verified_at', models.DateTimeField(blank=True, help_text='When email was verified', null=True)),
                ('phone_verified', models.BooleanField(default=False, help_text='Whether phone number has been verified')),
                ('phone_verified_at', models.DateTimeField(blank=True, help_text='When phone was verified', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('notify_new_assignments', models.BooleanField(default=True, help_text='Get notified when assigned new repairs')),
                ('notify_reassignments', models.BooleanField(default=True, help_text='Get notified when repairs are reassigned away')),
                ('notify_customer_approvals', models.BooleanField(default=True, help_text='Get notified when customers approve/deny repairs')),
                ('notify_reward_redemptions', models.BooleanField(default=True, help_text='Get notified of reward redemptions to fulfill')),
                ('digest_enabled', models.BooleanField(default=False, help_text='Receive daily digest instead of individual notifications')),
                ('digest_time', models.TimeField(blank=True, help_text='Time to send daily digest (e.g., 09:00)', null=True)),
                ('technician', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='notification_preferences', to='technician_portal.technician')),
            ],
            options={
                'verbose_name': 'Technician Notification Preference',
                'verbose_name_plural': 'Technician Notification Preferences',
            },
        ),
        migrations.CreateModel(
            name='NotificationDeliveryLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('channel', models.CharField(choices=[('email', 'Email'), ('sms', 'SMS'), ('in_app', 'In-App')], db_index=True, max_length=20)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('sent', 'Sent Successfully'), ('failed', 'Failed'), ('bounced', 'Bounced'), ('opted_out', 'User Opted Out'), ('skipped', 'Skipped (preferences/quiet hours)')], db_index=True, default='pending', max_length=20)),
                ('recipient_email', models.EmailField(blank=True, help_text='Email address used for delivery', max_length=254)),
                ('recipient_phone', models.CharField(blank=True, help_text='Phone number used for delivery', max_length=20)),
                ('provider_name', models.CharField(blank=True, help_text='Service provider (AWS SES, AWS SNS, etc.)', max_length=50)),
                ('provider_message_id', models.CharField(blank=True, db_index=True, help_text="Provider's unique message ID for tracking", max_length=200)),
                ('provider_response', models.JSONField(blank=True, default=dict, help_text='Full provider API response (for debugging)')),
                ('error_message', models.TextField(blank=True, help_text='Error message if delivery failed')),
                ('error_code', models.CharField(blank=True, help_text='Error code from provider', max_length=50)),
                ('attempt_number', models.PositiveIntegerField(default=1, help_text='Delivery attempt number (1, 2, 3...)')),
                ('max_attempts', models.PositiveIntegerField(default=3, help_text='Maximum retry attempts')),
                ('next_retry_at', models.DateTimeField(blank=True, help_text='Scheduled time for next retry attempt', null=True)),
                ('estimated_cost', models.DecimalField(blank=True, decimal_places=4, help_text='Estimated cost in USD (primarily for SMS)', max_digits=10, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('sent_at', models.DateTimeField(blank=True, help_text='When notification was successfully sent', null=True)),
                ('failed_at', models.DateTimeField(blank=True, help_text='When delivery failed', null=True)),
                ('celery_task_id', models.CharField(blank=True, db_index=True, help_text='Celery task ID for async delivery tracking', max_length=100)),
                ('notification', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='delivery_logs', to='core.notification')),
            ],
            options={
                'verbose_name': 'Notification Delivery Log',
                'verbose_name_plural': 'Notification Delivery Logs',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['notification', 'channel'], name='core_notifi_notific_98d541_idx'), models.Index(fields=['status', 'next_retry_at'], name='core_notifi_status_2f112e_idx'), models.Index(fields=['provider_message_id'], name='core_notifi_provide_e3312f_idx'), models.Index(fields=['created_at', 'channel'], name='core_notifi_created_bcff9b_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='notification',
            index=models.Index(fields=['recipient_type', 'recipient_id', '-created_at'], name='core_notifi_recipie_fb1c4c_idx'),
        ),
        migrations.AddIndex(
            model_name='notification',
            index=models.Index(fields=['priority', 'created_at'], name='core_notifi_priorit_c0cb06_idx'),
        ),
        migrations.AddIndex(
            model_name='notification',
            index=models.Index(fields=['category', 'read'], name='core_notifi_categor_43f670_idx'),
        ),
        migrations.AddIndex(
            model_name='notification',
            index=models.Index(fields=['repair_batch_id'], name='core_notifi_repair__362c8a_idx'),
        ),
    ]
