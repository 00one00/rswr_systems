# .ebextensions/celery_improved.config
# Enhanced Celery worker configuration with better logging and error handling

files:
  "/opt/elasticbeanstalk/tasks/bundlelogs.d/celery.conf":
    mode: "000755"
    owner: root
    group: root
    content: |
      /var/log/celery-worker.log
      /var/log/celery-beat.log
      /var/log/celery-startup.log

  "/usr/local/bin/start_celery_worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e

      # Log everything to startup log
      exec 2>&1 | tee -a /var/log/celery-startup.log

      echo "[$(date)] Starting Celery worker..."
      echo "[$(date)] Current directory: $(pwd)"
      echo "[$(date)] User: $(whoami)"

      # Change to app directory
      cd /var/app/current
      echo "[$(date)] Changed to: $(pwd)"

      # Find and activate virtual environment
      VENV_PATH=$(ls -d /var/app/venv/*/bin/activate 2>/dev/null | head -1)
      echo "[$(date)] Virtual environment path: $VENV_PATH"

      if [ -z "$VENV_PATH" ]; then
        echo "[$(date)] ERROR: Virtual environment not found!"
        exit 1
      fi

      source "$VENV_PATH"
      echo "[$(date)] Virtual environment activated"

      # Load environment variables
      if [ -f /opt/elasticbeanstalk/deployment/env ]; then
        echo "[$(date)] Loading environment variables..."
        export $(cat /opt/elasticbeanstalk/deployment/env | xargs)
        echo "[$(date)] Environment variables loaded"
        echo "[$(date)] CELERY_BROKER_URL: ${CELERY_BROKER_URL}"
      else
        echo "[$(date)] WARNING: Environment file not found"
      fi

      # Test Redis connection
      echo "[$(date)] Testing Redis connection..."
      python -c "import redis; r = redis.from_url('${CELERY_BROKER_URL}'); r.ping(); print('Redis connection OK')" || echo "[$(date)] WARNING: Redis connection failed"

      # Start Celery worker
      echo "[$(date)] Starting Celery worker process..."
      exec celery -A rs_systems worker \
        --loglevel=info \
        --logfile=/var/log/celery-worker.log \
        --concurrency=4 \
        --max-tasks-per-child=100 \
        --time-limit=300 \
        --soft-time-limit=240

  "/usr/local/bin/start_celery_beat.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e

      # Log everything to startup log
      exec 2>&1 | tee -a /var/log/celery-startup.log

      echo "[$(date)] Starting Celery beat..."

      cd /var/app/current

      # Find and activate virtual environment
      VENV_PATH=$(ls -d /var/app/venv/*/bin/activate 2>/dev/null | head -1)
      if [ -z "$VENV_PATH" ]; then
        echo "[$(date)] ERROR: Virtual environment not found!"
        exit 1
      fi

      source "$VENV_PATH"

      # Load environment variables
      if [ -f /opt/elasticbeanstalk/deployment/env ]; then
        export $(cat /opt/elasticbeanstalk/deployment/env | xargs)
      fi

      # Start Celery beat
      echo "[$(date)] Starting Celery beat process..."
      exec celery -A rs_systems beat \
        --loglevel=info \
        --logfile=/var/log/celery-beat.log \
        --pidfile=/var/run/celery-beat.pid \
        --schedule=/var/run/celerybeat-schedule

  "/etc/systemd/system/celery-worker.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Celery Worker Service
      After=network.target

      [Service]
      Type=simple
      User=webapp
      Group=webapp
      WorkingDirectory=/var/app/current
      ExecStart=/usr/local/bin/start_celery_worker.sh
      Restart=always
      RestartSec=10s
      StandardOutput=append:/var/log/celery-startup.log
      StandardError=append:/var/log/celery-startup.log

      [Install]
      WantedBy=multi-user.target

  "/etc/systemd/system/celery-beat.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Celery Beat Service
      After=network.target

      [Service]
      Type=simple
      User=webapp
      Group=webapp
      WorkingDirectory=/var/app/current
      ExecStart=/usr/local/bin/start_celery_beat.sh
      Restart=always
      RestartSec=10s
      StandardOutput=append:/var/log/celery-startup.log
      StandardError=append:/var/log/celery-startup.log

      [Install]
      WantedBy=multi-user.target

commands:
  01_create_log_files:
    command: |
      touch /var/log/celery-worker.log
      touch /var/log/celery-beat.log
      touch /var/log/celery-startup.log
      chown webapp:webapp /var/log/celery-*.log
    ignoreErrors: true

  02_stop_old_services:
    command: "systemctl stop celery-worker celery-beat || true"
    ignoreErrors: true

container_commands:
  01_reload_systemd:
    command: "systemctl daemon-reload"
    leader_only: false

  02_enable_celery_worker:
    command: "systemctl enable celery-worker"
    leader_only: false

  03_enable_celery_beat:
    command: "systemctl enable celery-beat"
    leader_only: false

  04_start_celery_worker:
    command: "systemctl start celery-worker && systemctl status celery-worker --no-pager || journalctl -u celery-worker -n 50 --no-pager"
    leader_only: false

  05_start_celery_beat:
    command: "systemctl start celery-beat && systemctl status celery-beat --no-pager || journalctl -u celery-beat -n 50 --no-pager"
    leader_only: false

  06_log_celery_status:
    command: |
      echo "=== Celery Worker Status ===" >> /var/log/celery-startup.log
      systemctl status celery-worker --no-pager >> /var/log/celery-startup.log 2>&1 || true
      echo "=== Celery Beat Status ===" >> /var/log/celery-startup.log
      systemctl status celery-beat --no-pager >> /var/log/celery-startup.log 2>&1 || true
    leader_only: false
    ignoreErrors: true
