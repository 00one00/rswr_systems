# .ebextensions/celery.config
# Celery worker and beat scheduler configuration for Elastic Beanstalk

files:
  "/opt/elasticbeanstalk/tasks/bundlelogs.d/celery.conf":
    mode: "000755"
    owner: root
    group: root
    content: |
      /var/log/celery-worker.log
      /var/log/celery-beat.log

  "/usr/local/bin/start_celery_worker.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/current
      source /var/app/venv/*/bin/activate
      export $(cat /opt/elasticbeanstalk/deployment/env | xargs)
      exec celery -A rs_systems worker \
        --loglevel=info \
        --logfile=/var/log/celery-worker.log \
        --concurrency=4 \
        --max-tasks-per-child=100 \
        --time-limit=300 \
        --soft-time-limit=240

  "/usr/local/bin/start_celery_beat.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/current
      source /var/app/venv/*/bin/activate
      export $(cat /opt/elasticbeanstalk/deployment/env | xargs)
      exec celery -A rs_systems beat \
        --loglevel=info \
        --logfile=/var/log/celery-beat.log \
        --pidfile=/var/run/celery-beat.pid \
        --schedule=/var/run/celerybeat-schedule

  "/etc/systemd/system/celery-worker.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Celery Worker Service
      After=network.target

      [Service]
      Type=simple
      User=webapp
      Group=webapp
      ExecStart=/usr/local/bin/start_celery_worker.sh
      Restart=on-failure
      RestartSec=5s

      [Install]
      WantedBy=multi-user.target

  "/etc/systemd/system/celery-beat.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Celery Beat Service
      After=network.target

      [Service]
      Type=simple
      User=webapp
      Group=webapp
      ExecStart=/usr/local/bin/start_celery_beat.sh
      Restart=on-failure
      RestartSec=5s

      [Install]
      WantedBy=multi-user.target

commands:
  01_stop_old_celery:
    command: "systemctl stop celery-worker celery-beat || true"
    ignoreErrors: true

container_commands:
  01_reload_systemd:
    command: "systemctl daemon-reload"

  02_enable_celery_worker:
    command: "systemctl enable celery-worker"

  03_enable_celery_beat:
    command: "systemctl enable celery-beat"

  04_start_celery_worker:
    command: "systemctl start celery-worker"

  05_start_celery_beat:
    command: "systemctl start celery-beat"
